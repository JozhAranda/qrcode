<!DOCTYPE HTML>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">    
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/css/snackbar.min.css" rel="stylesheet" />
    <link href="assets/css/home.css" rel="stylesheet" />
    <link href="assets/css/mobile.css" rel="stylesheet" />
    <link href="assets/css/wizard.css" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body onload="init()">

    <div class="row" style="margin-left: 0;margin-right: 0;">
      <div class="col-xs-12 headerLogo"style="margin: 30px 0 40px 0;">
        <div class="col-xs-6">
          <img src="assets/img/sspm_logo.png" class="img img-responsive headerImg" style="width: 125px;margin-top: 25px;" alt="logo" />
        </div>
        <div class="col-xs-6">
          <p class="headerText">
            Aplicación de Control de
            <span style="color: rgba(0, 23, 52, 0.8);font-weight: 600;"> Parte Novedades</span>
          </p>
          <p id="here"></p>
        </div>
      </div>      
      <div class="container">
        <div class="stepwizard">
            <div class="stepwizard-row setup-panel">
                <div class="stepwizard-step">
                    <a href="#step-1" type="button" class="btn btn-primary btn-circle"></a>
                    <p>Información General</p>
                </div>
                <div class="stepwizard-step">
                    <a href="#step-2" type="button" class="btn btn-default btn-circle" disabled="disabled"></a>
                    <p>Reporte</p>
                </div>
                <div class="stepwizard-step">
                    <a href="#step-3" type="button" class="btn btn-default btn-circle" disabled="disabled"></a>
                    <p>Seguimiento</p>
                </div>
                <div class="stepwizard-step">
                    <a href="#step-4" type="button" class="btn btn-default btn-circle" disabled="disabled"></a>
                    <p>Guardar</p>
                </div>
            </div>
        </div>
        <form class="form col-xs-12" role="form" id="formFine" enctype="multipart/form-data">
            <div class="row setup-content" id="step-1">
                <div class="col-xs-12">
                    <div class="col-md-12">
                        <h3>Información General</h3>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Número de Incidente</label> 
                            <input type="text" name="numIncidente" id="numIncidente" class="form-control inputShadow" placeholder="# Incidente" maxlength="25" />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Bajo Reporte</label>
                            <select name="bajoReporte" id="bajoReporte" class="form-control inputShadow" required/>
                              <option value="">BAJO REPORTE</option>
                              <option value="CENTRAL DE RADIO">CENTRAL DE RADIO</option>
                              <option value="UNIDAD">UNIDAD</option>
                              <option value="VIA DENUNCIA (089)">VIA DENUNCIA (089)</option>
                              <option value="VIA DENUNCIA (066)">VIA DENUNCIA (066)</option>
                              <option value="SUPERVISOR">SUPERVISOR</option>
                              <option value="REPORTANTE">REPORTANTE</option>
                              <option value="SOBRE RECORRIDO">SOBRE RECORRIDO</option>
                              <option value="NO ESPECIFICADO">NO ESPECIFICADO</option>
                            </select>
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Se atiende</label>
                            <input type="text" name="atiende" id="atiende" class="form-control inputShadow" placeholder="Se atiende" required />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Fecha (Evento)</label>
                            <input type="date" name="fechaEvento" id="fechaEvento" class="form-control inputShadow" placeholder="Fecha (Evento)" required />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Hora (Reporte)</label>
                            <input type="time" name="horaReporte" id="horaReporte" class="form-control inputShadow" placeholder="Hora (Reporte)" required />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Hora (Llegada)</label>
                            <input type="time" name="horaLlegada" id="horaLlegada" class="form-control inputShadow" placeholder="Hora (Llegada)" required />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Calle</label>
                            <input type="text" name="calle" id="calle" class="form-control inputShadow" placeholder="Calle" required />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Número Int/Ext</label>
                            <input type="text" name="numeroIntExt" id="numeroIntExt" class="form-control inputShadow" placeholder="Número Int/Ext" />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Colonia</label>
                            <input type="text" name="colonia" id="colonia" class="form-control inputShadow" placeholder="Colonia" />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Calle lateral izquierda</label>
                            <input type="text" name="calleIzquierda" id="calleIzquierda" class="form-control inputShadow" placeholder="Calle lateral izquierda" />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Calle lateral derecha</label>
                            <input type="text" name="calleDerecha" id="calleDerecha" class="form-control inputShadow" placeholder="Calle lateral derecha" />
                        </div>
                        <div class="clearfix"></div>
                        <div class="form-group col-xs-2 col-xs-offset-5 text-center">
                          <button class="btn btn-primary nextBtn" type="button">
                            <img src="assets/img/arrow.png" width="24" />
                          </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row setup-content" id="step-2">
                <div class="col-xs-12">
                    <div class="col-md-12">
                        <h3>Reporte</h3>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Nombre del reportante</label>
                            <input type="text" name="nombreReportante" id="nombreReportante" class="form-control inputShadow" placeholder="Nombre del reportante" required />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Nombre del presunto responsable</label>
                            <input type="text" name="nombrePresunto" id="nombrePresunto" class="form-control inputShadow" placeholder="Nombre del presunto culpable" />
                        </div>                        
                        <div class="form-group col-xs-12 col-sm-12">
                            <label class="control-label">Reporte (Manifesta)</label>
                            <textarea name="reporteManifesta" id="reporteManifesta" class="form-control inputShadow" placeholder="Reporte (de los hechos y situación)" rows="5" style="resize: none;" required></textarea>
                        </div>
                        <div class="form-group col-xs-12 col-sm-4">
                            <label class="control-label">¿Hubo solución?</label>
                            <input type="radio" style="margin: 7px;" name="huboSolucion" value="SI">SI
                            <input type="radio" style="margin: 7px;" name="huboSolucion" value="NO">NO
                        </div>                       
                        <div class="form-group col-xs-12 col-sm-12">
                            <label class="control-label">Acuerdo (Ambas partes)</label>
                            <textarea name="reporteAcuerdo" id="reporteAcuerdo" class="form-control inputShadow" placeholder="Si hubo solución o no, ¿por qué?" rows="5" style="resize: none;"></textarea>
                        </div>
                        <div class="clearfix"></div>
                        <div class="form-group col-xs-2 col-xs-offset-5 text-center">
                          <button class="btn btn-primary nextBtn" type="button">
                            <img src="assets/img/arrow.png" width="24" />
                          </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row setup-content" id="step-3">
                <div class="col-xs-12">
                    <div class="col-md-12">
                        <h3>Seguimiento</h3>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Se Presenta ante</label>
                            <select name="presentaAnte" id="presentaAnte" class="form-control inputShadow">
                              <option value="">Se presenta ante</option>
                              <option value="M.P. FUERO COMUN">MINISTERIO PUBLICO DEL FUERO COMUN</option>
                              <option value="M.P. FUERO FEDERAL">MINISTERIO PUBLICO DEL FUERO FEDERAL</option>
                              <option value="EMI">EMI</option>
                              <option value="AMONESTACION">AMONESTACION</option>
                            </select>
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Número de Reporte</label> 
                            <input type="text" name="numeroReporte" id="numeroReporte" class="form-control inputShadow" placeholder="Número de Reporte" maxlength="25" />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Número de Infracción (Boleta)</label> 
                            <input type="text" name="numeroInfraccion" id="numeroInfraccion" class="form-control inputShadow" placeholder="Número de Infracción (Boleta)" maxlength="25" />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4 divOficial">
                            <label class="control-label">Matrícula de Oficiales</label> 
                            <button class="btn btn-info btn-sm addOficial" style="float: right;"> + </button>
                            <input type="text" name="matriculaOficial" id="matriculaOficial" class="form-control inputShadow" placeholder="Matrícula de Oficial" maxlength="25" required />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4 divUnidad">
                            <label class="control-label">Número de Unidades</label> 
                            <button class="btn btn-info btn-sm addUnidad" style="float: right;"> + </button>
                            <input type="text" name="numeroUnidad" id="numeroUnidad" class="form-control inputShadow" placeholder="(Añade prefijo P- o M-)" maxlength="25" required />
                        </div>
                        <div class="form-group col-xs-6 col-sm-4">
                            <label class="control-label">Matrícula de Superior (inmediato)</label> 
                            <input type="text" name="matriculaSuperior" id="matriculaSuperior" class="form-control inputShadow" placeholder="Matrícula de Superior" maxlength="25" required />
                        </div>
                        <div class="clearfix"></div>
                        <div class="form-group col-xs-2 col-xs-offset-5 text-center">
                          <button class="btn btn-primary nextBtn" type="button">
                            <img src="assets/img/arrow.png" width="24" />
                          </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row setup-content" id="step-4">
              <div class="col-xs-12">
                <div class="col-md-12">
                  <h3>Guardar</h3>    
                  <p>Recuerda haber relatado todos los hechos sucitados antes, durante y despues de la intervención.</p>          
                  <div class="clearfix"></div>
                  <div class="form-group col-xs-4 col-xs-offset-4 text-center">
                    <button class="btn btn-primary btn-block" id="submitParte" type="submit">
                      <img src="assets/img/save.png" width="24" />
                    </button>
                  </div>
                </div>
              </div>
            </div>
        </form>
      </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="cordova.js" type="text/javascript"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/snackbar.min.js"></script>
    <script src="assets/js/wizard.js"></script>
    <script src="assets/js/moreInput.js"></script>

    <script type="text/javascript" charset="utf-8">
      document.addEventListener("deviceready", onDeviceReady, false);

      function onDeviceReady() {

        $('#submitParte').on('click touch', function(event) {

          event.preventDefault();
          /**/
          var numIncidente  = $('#numIncidente').val(); 
          var bajoReporte   = $('#bajoReporte').val(); 
          var atiende       = $('#atiende').val(); 
          var fechaEvento   = $('#fechaEvento').val(); 
          var horaReporte   = $('#horaReporte').val(); 
          var horaLlegada   = $('#horaLlegada').val();
          var calle         = $('#calle').val();
          var numeroIntExt  = $('#numeroIntExt').val();
          var colonia       = $('#colonia').val();
          var calleIzquierda    = $('#calleIzquierda').val();
          var calleDerecha      = $('#calleDerecha').val();
          var nombreReportante  = $('#nombreReportante').val();
          var nombrePresunto    = $('#nombrePresunto').val();
          var reporteManifesta  = $('#reporteManifesta').val();
          var huboSolucion      = $('#huboSolucion').val();
          var reporteAcuerdo    = $('#reporteAcuerdo').val();
          var presentaAnte      = $('#presentaAnte').val();
          var numeroReporte     = $('#numeroReporte').val();
          var numeroInfraccion  = $('#numeroInfraccion').val();
          var matriculaOficial  = $('#matriculaOficial').val();
          var numeroUnidad      = $('#numeroUnidad').val();
          var matriculaSuperior = $('#matriculaSuperior').val();
          /**/

          var db = window.sqlitePlugin.openDatabase({name: "partenovedad.db"});

          db.transaction(function(tx) {
            tx.executeSql('DROP TABLE IF EXISTS parte_novedad');
            tx.executeSql('CREATE TABLE IF NOT EXISTS parte_novedad (id integer primary key, numIncidente text, bajoReporte text, atiende text, fechaEvento datetime, horaReporte text, horaLlegada text, calle text, numeroIntExt text, colonia text, calleIzquierda text, calleDerecha text, nombreReportante text, nombrePresunto text, reporteManifesta text, huboSolucion text, reporteAcuerdo text, presentaAnte text, numeroReporte text, numeroInfraccion text, matriculaOficial integer, numeroUnidad text, matriculaSuperior integer)');

            tx.executeSql("INSERT INTO parte_novedad (numIncidente, bajoReporte, atiende, fechaEvento, horaReporte, horaLlegada, calle, numeroIntExt, colonia, calleIzquierda, calleDerecha, nombreReportante, nombrePresunto, reporteManifesta, huboSolucion, reporteAcuerdo, presentaAnte, numeroReporte, numeroInfraccion, matriculaOficial, numeroUnidad, matriculaSuperior) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", 
              [numIncidente, bajoReporte, atiende, fechaEvento, horaReporte, horaLlegada, calle, numeroIntExt, colonia, calleIzquierda, calleDerecha, nombreReportante, nombrePresunto, reporteManifesta, huboSolucion, reporteAcuerdo, presentaAnte, numeroReporte, numeroInfraccion, matriculaOficial, numeroUnidad, matriculaSuperior], 
              function(tx, res) {
                
                tx.executeSql("SELECT * FROM parte_novedad;", 
                  [], 
                  function(tx, res) {
                /*****************************/  
                    var xhr = new XMLHttpRequest();
                    var url = "http://policiatijuana.gob.mx/";
                    xhr.addEventListener('readystatechange', state_change, true);
                    xhr.open("GET", url, true);
                    xhr.send(null);
                    
                    function state_change() {
                       
                      if (xhr.status === 200) {

                        for(var i = 0; i < res.rows.length; i++) {

                          $.ajax({
                            method: 'POST',
                            url: 'http://joshuaranda.com/sspm/partenovedad/',
                            async: true,
                            crossDomain: true,
                            data: { 
                              numIncidente: res.rows.item(i).numIncidente, 
                              bajoReporte : res.rows.item(i).bajoReporte, 
                              atiende     : res.rows.item(i).atiende, 
                              fechaEvento : res.rows.item(i).fechaEvento, 
                              horaReporte : res.rows.item(i).horaReporte, 
                              horaLlegada : res.rows.item(i).horaLlegada, 
                              calle       : res.rows.item(i).calle, 
                              numeroIntExt: res.rows.item(i).numeroIntExt, 
                              colonia     : res.rows.item(i).colonia, 
                              calleIzquierda: res.rows.item(i).calleIzquierda, 
                              calleDerecha  : res.rows.item(i).calleDerecha, 
                              nombreReportante: res.rows.item(i).nombreReportante, 
                              nombrePresunto  : res.rows.item(i).nombrePresunto, 
                              reporteManifesta: res.rows.item(i).reporteManifesta, 
                              huboSolucion    : res.rows.item(i).huboSolucion, 
                              reporteAcuerdo  : res.rows.item(i).reporteAcuerdo, 
                              presentaAnte    : res.rows.item(i).presentaAnte, 
                              numeroReporte   : res.rows.item(i).numeroReporte, 
                              numeroInfraccion: res.rows.item(i).numeroInfraccion, 
                              matriculaOficial: res.rows.item(i).matriculaOficial, 
                              numeroUnidad    : res.rows.item(i).numeroUnidad, 
                              matriculaSuperior: res.rows.item(i).matriculaOficial
                            },
                            cache: false,        
                            beforeSend: function(){ $(".loader").fadeOut("200").css("display", "block"); },
                            success: function(data) {   
                              $(".loader").css("display", "none");
                              $.snackbar({
                                content: "Parte novedad ingresada.", 
                                timeout: 5000
                              });        
                              tx.executeSql('TRUNCATE TABLE parte_novedad'); 
                              tx.executeSql('DROP TABLE parte_novedad'); 
                              window.sqlitePlugin.deleteDatabase({name: "partenovedad.db"}); 
                              location.reload();
                            },
                            error: function(xhr, textStatus, errorThrown) {
                              if (textStatus === 'timeout') {
                                this.tryCount++;
                                if (this.tryCount <= 2) {
                                  $.ajax(this);
                                  return;
                                }            
                                return;
                              }  
                              $(".loader").css("display", "none");        
                              if (xhr.status === 500) {
                                $.snackbar({
                                  content: "Ocurrio un error, no desistas e intentalo nuevamente", 
                                  timeout: 5000
                                }); 
                              } else {
                                $.snackbar({
                                  content: "Ocurrio un error, posiblemente el servidor no responde", 
                                  timeout: 5000
                                }); 
                              }
                            }
                          });
                        }
                      
                      }
                    }                  
              /****************************/
                });

            }, function(e) {

              alert("ERROR: " + e.message);
            });

          });
          
        });

      /*******************************************/
        var db = window.sqlitePlugin.openDatabase({name: "partenovedad.db"});

        db.transaction(function(tx) {
          tx.executeSql("SELECT * FROM parte_novedad;", 
            [], 
            function(tx, res) { 
              var xhr = new XMLHttpRequest();
              var url = "http://policiatijuana.gob.mx/";
              xhr.addEventListener('readystatechange', state_change, true);
              xhr.open("GET", url, true);
              xhr.send(null);
              
              function state_change() {
                 
                if (xhr.status === 200) {

                  for(var i = 0; i < res.rows.length; i++) {

                    $.ajax({
                      method: 'POST',
                      url: 'http://joshuaranda.com/sspm/partenovedad/',
                      async: true,
                      crossDomain: true,
                      data: { 
                        numIncidente: res.rows.item(i).numIncidente, 
                        bajoReporte : res.rows.item(i).bajoReporte, 
                        atiende     : res.rows.item(i).atiende, 
                        fechaEvento : res.rows.item(i).fechaEvento, 
                        horaReporte : res.rows.item(i).horaReporte, 
                        horaLlegada : res.rows.item(i).horaLlegada, 
                        calle       : res.rows.item(i).calle, 
                        numeroIntExt: res.rows.item(i).numeroIntExt, 
                        colonia     : res.rows.item(i).colonia, 
                        calleIzquierda: res.rows.item(i).calleIzquierda, 
                        calleDerecha  : res.rows.item(i).calleDerecha, 
                        nombreReportante: res.rows.item(i).nombreReportante, 
                        nombrePresunto  : res.rows.item(i).nombrePresunto, 
                        reporteManifesta: res.rows.item(i).reporteManifesta, 
                        huboSolucion    : res.rows.item(i).huboSolucion, 
                        reporteAcuerdo  : res.rows.item(i).reporteAcuerdo, 
                        presentaAnte    : res.rows.item(i).presentaAnte, 
                        numeroReporte   : res.rows.item(i).numeroReporte, 
                        numeroInfraccion: res.rows.item(i).numeroInfraccion, 
                        matriculaOficial: res.rows.item(i).matriculaOficial, 
                        numeroUnidad    : res.rows.item(i).numeroUnidad, 
                        matriculaSuperior: res.rows.item(i).matriculaOficial
                      },
                      cache: false,        
                      beforeSend: function(){ $(".loader").fadeOut("200").css("display", "block"); },
                      success: function(data) {   
                        $(".loader").css("display", "none");
                        $.snackbar({
                          content: "Parte novedad ingresada.", 
                          timeout: 5000
                        });         
                      },
                      error: function(xhr, textStatus, errorThrown ) {
                        if (textStatus === 'timeout') {
                          this.tryCount++;
                          if (this.tryCount <= 1) {
                            $.ajax(this);
                            return;
                          }            
                          return;
                        }  
                        $(".loader").css("display", "none");        
                        if (xhr.status === 500) {
                          $.snackbar({
                            content: "Ocurrio un error, intentalo nuevamente", 
                            timeout: 5000
                          }); 
                        } else {
                          $.snackbar({
                            content: "Ocurrio un error, posiblemente el servidor no responde", 
                            timeout: 5000
                          }); 
                        }
                      }
                    });
                  }

                  tx.executeSql('TRUNCATE TABLE parte_novedad'); 
                  tx.executeSql('DROP TABLE parte_novedad'); 
                  window.sqlitePlugin.deleteDatabase({name: "partenovedad.db"});
                  //location.reload();                
                }
              }
            });          
          });
      /******************************************/

      }
    </script>
  </body>
</html> 